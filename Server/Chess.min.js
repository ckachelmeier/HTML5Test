var __extends=this.__extends||function(n,t){function i(){this.constructor=n}i.prototype=t.prototype,n.prototype=new i},Chess;(function(n){function w(n,i){var r,u;return n.pageX!=undefined&&n.pageY!=undefined?(r=n.pageX,u=n.pageY):(r=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,u=n.clientY+document.body.scrollTop+document.documentElement.scrollTop),r-=i.offsetLeft,u-=i.offsetTop,new t(r,u)}function f(n,t){n.color==i.BLACK?(t.fillStyle="#000",t.font="bold 12px sans-serif"):(t.fillStyle="#222",t.font="12px sans-serif")}var r,y,p,e,i,t,u;(function(n){n._map=[],n._map[0]="CHECK",n.CHECK=0,n._map[1]="CHECKMATE",n.CHECKMATE=1,n._map[2]="STALEMATE",n.STALEMATE=2,n._map[3]="PLAY",n.PLAY=3})(r||(r={})),y=function(){function n(n){var t=this;$(n).click(function(n){return t.handleClick(n)}),this.context=n.getContext("2d"),this.board=new e(this.context),n.height=n.height+50,this.moves=0,this.currentTurn=i.WHITE,this.gameState=r.PLAY,this.Refresh()}return n.prototype.Refresh=function(){this.board.Display(),this.context.fillStyle="#000",this.context.font="bold 12px sans-serif",this.context.fillText("Turn: "+(this.currentTurn==i.WHITE?"White":"Black"),10,this.board.sideLength+20,100),this.context.stroke();var n="";switch(this.gameState){case r.CHECK:n="Check";break;case r.CHECKMATE:n="Checkmate.  Game over";break;case r.STALEMATE:n="Stalemate"}this.context.fillText(n,200,this.board.sideLength+20)},n.prototype.handleClick=function(n){var o,h,c,u,f,e,s;h=$(n.target)[0],o=w(n,h),u=new t(Math.floor(o.X/this.board.squareLength),Math.floor(o.Y/this.board.squareLength)),c=this.board.tryMove(u),c?(this.moves++,this.currentTurn=this.currentTurn==i.WHITE?i.BLACK:i.WHITE,f=this.board.isInCheck(this.currentTurn),e=this.board.playerHasMoves(this.currentTurn),this.gameState=r.PLAY,f&&e?this.gameState=r.CHECK:f&&!e?this.gameState=r.CHECKMATE:f||e||(this.gameState=r.STALEMATE)):(s=this.board.getPieceAtPosition(u),s!=null&&s.color==this.currentTurn&&(this.board.selected=u)),this.Refresh()},n}(),n.ChessContext=y,p=function(){function n(n){var t=this;$(n).click(function(n){return t.handleClick(n)}),this.context=n.getContext("2d"),this.board=new e(this.context),n.height=n.height+50,this.moves=0,this.currentTurn=i.WHITE,this.gameState=r.PLAY,this.Refresh(),this.started=!1,this.waitingForResponse=!1,this.connection=new WebSocket("ws://localhost:8080",["soap","xmpp"]),this.connection.onmessage=function(n){t.HandleMessage(n)},this.connection.onclose=function(){t.HandleClose},console.log("starting...")}return n.prototype.HandleClose=function(){console.log("Closing...")},n.prototype.HandleMessage=function(n){var t;t=n.data,console.log(t);var f=t.indexOf(":"),u=t.substring(0,f).trim(),r=t.substring(f+1).trim();if(f<0&&(u=t.trim(),r=""),console.log(u),console.log(r),this.started){switch(u){case"accepted":this.HandleMoveAccepted(),this.waitingForResponse=!1;break;case"rejected":this.waitingForResponse=!1,this.board.board=JSON.parse(r),alert("Oh Noes!!!");break;case"opponentmove":this.HandleMoveAccepted(),this.board.SetBoard(JSON.parse(r)),this.Refresh()}console.log("started: "+this.started)}else u=="color"&&(this.myColor=r.toLowerCase()=="white"?i.WHITE:i.BLACK,this.started=!0,console.log("started: "+this.started))},n.prototype.Refresh=function(){this.board.Display(),this.context.fillStyle="#000",this.context.font="bold 12px sans-serif",this.context.fillText("Turn: "+(this.currentTurn==i.WHITE?"White":"Black"),10,this.board.sideLength+20,100),this.context.stroke();var n="";switch(this.gameState){case r.CHECK:n="Check";break;case r.CHECKMATE:n="Checkmate.  Game over";break;case r.STALEMATE:n="Stalemate"}this.context.fillText(n,200,this.board.sideLength+20)},n.prototype.HandleMoveAccepted=function(){this.waitingForResponse=!1,this.moves++,this.currentTurn=this.currentTurn==i.WHITE?i.BLACK:i.WHITE;var n=this.board.isInCheck(this.currentTurn),t=this.board.playerHasMoves(this.currentTurn);this.gameState=r.PLAY,n&&t?this.gameState=r.CHECK:n&&!t?this.gameState=r.CHECKMATE:n||t||(this.gameState=r.STALEMATE)},n.prototype.SendMove=function(n,t){var i=JSON.stringify([n,t]);this.connection.send("move:"+i),this.waitingForResponse=!0},n.prototype.handleClick=function(n){var u,e,o,s,r,f;(console.log("Started: "+this.started),console.log("My Turn: "+(this.currentTurn==this.myColor)),console.log(this.currentTurn==i.BLACK?"Black":this.currentTurn==i.WHITE?"White":"not set"),console.log(this.myColor==i.BLACK?"Black":this.myColor==i.WHITE?"White":"not set"),console.log("waiting: "+this.waitingForResponse),this.started&&this.currentTurn==this.myColor&&!this.waitingForResponse)&&(e=$(n.target)[0],u=w(n,e),r=new t(Math.floor(u.X/this.board.squareLength),Math.floor(u.Y/this.board.squareLength)),o=this.board.selected,s=this.board.tryMove(r),s?this.SendMove(o,r):(f=this.board.getPieceAtPosition(r),f!=null&&f.color==this.currentTurn&&(this.board.selected=r)),this.Refresh())},n}(),n.ChessClientContext=p,e=function(){function n(n){var u,r;for(this.board=new Array(8),u=0;u<8;u++)this.board[u]=new Array(8);for(this.selected=null,this.context=n,n!=null&&(this.sideLength=n.canvas.width<n.canvas.height?n.canvas.width:n.canvas.height,this.context.canvas.width=this.sideLength+1,this.context.canvas.height=this.sideLength+1,this.squareLength=this.sideLength/8,console.log(this.squareLength),console.log(this.sideLength)),r=0;r<8;r++)this.board[1][r]=new c(i.WHITE,new t(1,r),this.squareLength),this.board[6][r]=new c(i.BLACK,new t(6,r),this.squareLength);this.board[0][0]=new o(i.WHITE,new t(0,0),this.squareLength),this.board[0][1]=new h(i.WHITE,new t(0,1),this.squareLength),this.board[0][2]=new s(i.WHITE,new t(0,2),this.squareLength),this.board[0][3]=new a(i.WHITE,new t(0,3),this.squareLength),this.board[0][4]=new v(i.WHITE,new t(0,4),this.squareLength),this.board[0][5]=new s(i.WHITE,new t(0,5),this.squareLength),this.board[0][6]=new h(i.WHITE,new t(0,6),this.squareLength),this.board[0][7]=new o(i.WHITE,new t(0,7),this.squareLength),this.board[7][0]=new o(i.BLACK,new t(7,0),this.squareLength),this.board[7][1]=new h(i.BLACK,new t(7,1),this.squareLength),this.board[7][2]=new s(i.BLACK,new t(7,2),this.squareLength),this.board[7][3]=new a(i.BLACK,new t(7,3),this.squareLength),this.board[7][4]=new v(i.BLACK,new t(7,4),this.squareLength),this.board[7][5]=new s(i.BLACK,new t(7,5),this.squareLength),this.board[7][6]=new h(i.BLACK,new t(7,6),this.squareLength),this.board[7][7]=new o(i.BLACK,new t(7,7),this.squareLength),this.Display()}return n.prototype.checkMoveForCheck=function(n,t,r){var u,f,e;return(console.log("checkMoveForCheck: "+n.X+","+n.Y+" "+t.X+","+t.Y+": "+(i.WHITE==r?"White":"Black")),this.getPieceAtPosition(n)==null)?!1:(u=this.getPieceAtPosition(n),f=this.getPieceAtPosition(t),this.board[t.X][t.Y]=u,this.board[u.position.X][u.position.Y]=null,u.position=t,e=this.isInCheck(r),this.board[t.X][t.Y]=f,this.board[n.X][n.Y]=u,u.position=n,e)},n.prototype.isInCheck=function(n){var h,f,t,r,o,s,e;for(console.log("isInCheck: "+(i.WHITE==n?"White":"Black")),t=0;t<8;t++)for(r=0;r<8;r++)f=this.board[t][r],f!=null&&f.type==u.King&&f.color==n&&(h=f.position);for(t=0;t<8;t++)for(r=0;r<8;r++)if(o=this.board[t][r],o!=null&&o.color!=n)for(s=o.GetValidMoves(this,!1),e=0;e<s.length;e++)if(h.X==s[e].X&&h.Y==s[e].Y)return!0;return!1},n.prototype.playerHasMoves=function(n){for(var i,r,u,t=0;t<8;t++)for(i=0;i<8;i++)if(r=this.board[t][i],r!=null&&r.color==n&&(u=r.GetValidMoves(this,!0),u!=null&&u.length>0))return!0;return!1},n.prototype.tryMove=function(n){var r,t,i;if(this.selected!=null&&(r=this.getPieceAtPosition(this.selected),t=r.GetValidMoves(this,!0),t!=null))for(i=0;i<t.length;i++)if(t[i].X==n.X&&t[i].Y==n.Y)return this.board[n.X][n.Y]=this.board[this.selected.X][this.selected.Y],r.position=n,r.hasMoved=!0,this.board[this.selected.X][this.selected.Y]=null,this.selected=null,!0;return!1},n.prototype.getPieceAtPosition=function(n){if(n.X>=0&&n.X<8&&n.Y>=0&&n.Y<8)return this.board[n.X][n.Y]},n.prototype.Display=function(){var t,n,i;if(this.context!=null){if(this.context.canvas.height=this.context.canvas.height,this.selected!=null&&(this.context.fillStyle="#F00",this.context.fillRect(this.selected.X*this.squareLength,this.selected.Y*this.squareLength,this.squareLength,this.squareLength),this.context.fillStyle="#0F0",this.board[this.selected.X][this.selected.Y]!=null&&(t=this.board[this.selected.X][this.selected.Y].GetValidMoves(this,!0),t!=null)))for(n=0;n<t.length;n++)this.context.fillRect(t[n].X*this.squareLength,t[n].Y*this.squareLength,this.squareLength,this.squareLength);for(this.context.stroke(),this.context.beginPath(),n=0;n<9;n++)this.context.moveTo(0,n*this.squareLength+.5),this.context.fillText("y: "+n*this.squareLength,10,n*this.squareLength+10),this.context.lineTo(this.sideLength,n*this.squareLength+.5),this.context.moveTo(n*this.squareLength+.5,0),this.context.fillText("x: "+n*this.squareLength,n*this.squareLength+10,10),this.context.lineTo(n*this.squareLength+.5,this.sideLength);for(n=0;n<8;n++)for(i=0;i<8;i++)this.board[n][i]!=undefined&&this.board[n][i].Display(this.context);this.context.closePath(),this.context.lineWidth=1,this.context.stroke()}},n.prototype.SetBoard=function(n){for(var i,e,t,r,f=0;f<8;f++){for(i="",e=0;e<8;e++)if(n[f][e]==null)this.board[f][e]=null,i+="X";else{t=n[f][e];switch(t.type){case u.Bishop:r=new s(t.color,t.position,this.squareLength),i+="B";break;case u.King:r=new v(t.color,t.position,this.squareLength),i+="K";break;case u.Knight:r=new h(t.color,t.position,this.squareLength),i+="K";break;case u.Pawn:r=new c(t.color,t.position,this.squareLength),i+="P";break;case u.Queen:r=new a(t.color,t.position,this.squareLength),i+="Q";break;case u.Rook:r=new o(t.color,t.position,this.squareLength),i+="Q";break;default:i+=":"}r.hasMoved=t.hasMoved,this.board[f][e]=r}console.log(i)}},n}(),n.Board=e,function(n){n._map=[],n._map[0]="BLACK",n.BLACK=0,n._map[1]="WHITE",n.WHITE=1}(n.ChessColor||(n.ChessColor={})),i=n.ChessColor,t=function(){function n(n,t){this.X=n,this.Y=t}return n}(),n.Position=t,function(n){n._map=[],n._map[0]="Pawn",n.Pawn=0,n._map[1]="Rook",n.Rook=1,n._map[2]="Knight",n.Knight=2,n._map[3]="Bishop",n.Bishop=3,n._map[4]="Queen",n.Queen=4,n._map[5]="King",n.King=5}(u||(u={}));var c=function(){function n(n,t,i){this.color=n,this.position=t,this.size=i,this.position=t,this.color=n,this.size=i,this.hasMoved=!1,this.type=u.Pawn}return n.prototype.getRelativePosition=function(n,r){return this.color==i.WHITE?new t(this.position.X+n,this.position.Y+r):new t(this.position.X-n,this.position.Y+r)},n.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!0),console.log("Get moves Pawn: "+t);var u=[],i,r;return i=this.getRelativePosition(1,0,n),r=n.getPieceAtPosition(i),r==null&&(t&&n.checkMoveForCheck(this.position,i,this.color)||(u[u.length]=i),i=this.getRelativePosition(2,0,n),r=n.getPieceAtPosition(i),this.hasMoved||r!=null||t&&n.checkMoveForCheck(this.position,i,this.color)||(u[u.length]=i)),this.position.Y>0&&(i=this.getRelativePosition(1,-1,n),r=n.getPieceAtPosition(i),r==null||r.color==this.color||t&&n.checkMoveForCheck(this.position,i,this.color)||(u[u.length]=i)),this.position.Y<7&&(i=this.getRelativePosition(1,1,n),r=n.getPieceAtPosition(i),r==null||r.color==this.color||t&&n.checkMoveForCheck(this.position,i,this.color)||(u[u.length]=i)),u},n.prototype.Display=function(n){f(this,n),n.fillText("PAWN",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},n}(),l=function(){function n(n,t,i){this.color=n,this.position=t,this.size=i,this.position=t,this.color=n,this.size=i,this.hasMoved=!1}return n.prototype.GetValidMovesInDirection=function(n,i,r,u){var e,f;typeof u=="undefined"&&(u=!0);for(var o=[],s=!0,h=n,c=i;s;)f=f=new t(this.position.X+h,this.position.Y+c),f.X>=0&&f.X<8&&f.Y>=0&&f.Y<8?(e=r.getPieceAtPosition(f),s=e==null,e!=null&&e.color==this.color||u&&r.checkMoveForCheck(this.position,f,this.color)||(o[o.length]=f),h=h+n,c=c+i):s=!1;return o},n.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!1)},n.prototype.Display=function(){},n}(),o=function(n){function t(t,i,r){n.call(this,t,i,r),this.color=t,this.position=i,this.size=r,this.type=u.Rook}return __extends(t,n),t.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!0),console.log("Get moves rook: "+t);var i=[];return i=this.GetValidMovesInDirection(1,0,n,t),i=i.concat(this.GetValidMovesInDirection(-1,0,n,t)),i=i.concat(this.GetValidMovesInDirection(0,1,n,t)),i.concat(this.GetValidMovesInDirection(0,-1,n,t))},t.prototype.Display=function(n){f(this,n),n.fillText("ROOK",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},t}(l),s=function(n){function t(t,i,r){n.call(this,t,i,r),this.color=t,this.position=i,this.size=r,this.type=u.Bishop}return __extends(t,n),t.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!0),console.log("Get moves Bishop: "+t);var i=[];return i=this.GetValidMovesInDirection(1,1,n,t),i=i.concat(this.GetValidMovesInDirection(-1,1,n,t)),i=i.concat(this.GetValidMovesInDirection(1,-1,n,t)),i.concat(this.GetValidMovesInDirection(-1,-1,n,t))},t.prototype.Display=function(n){f(this,n),n.fillText("BISHOP",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},t}(l),a=function(n){function t(t,i,r){n.call(this,t,i,r),this.color=t,this.position=i,this.size=r,this.type=u.Queen}return __extends(t,n),t.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!0),console.log("Get moves Queen: "+t);var i=[];return i=this.GetValidMovesInDirection(1,0,n,t),i=i.concat(this.GetValidMovesInDirection(-1,0,n,t)),i=i.concat(this.GetValidMovesInDirection(0,1,n,t)),i=i.concat(this.GetValidMovesInDirection(0,-1,n,t)),i=i.concat(this.GetValidMovesInDirection(1,1,n,t)),i=i.concat(this.GetValidMovesInDirection(-1,1,n,t)),i=i.concat(this.GetValidMovesInDirection(1,-1,n,t)),i.concat(this.GetValidMovesInDirection(-1,-1,n,t))},t.prototype.Display=function(n){f(this,n),n.fillText("QUEEN",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},t}(l),b=function(){function n(n,t,i){this.color=n,this.position=t,this.size=i,this.position=t,this.color=n,this.size=i,this.hasMoved=!1}return n.prototype.MoveIsValid=function(n,i,r,u){if(typeof u=="undefined"&&(u=!0),this.position.X+n>=0&&this.position.X+n<8&&this.position.Y+i>=0&&this.position.Y+i<8){var f;return f=r.board[this.position.X+n][this.position.Y+i],(f==null||f.color!=this.color)&&(!u||!r.checkMoveForCheck(this.position,new t(this.position.X+n,this.position.Y+i),this.color))}return!1},n.prototype.GetValidMoves=function(n,t){typeof t=="undefined"&&(t=!0)},n.prototype.Display=function(){},n}(),v=function(n){function i(t,i,r){n.call(this,t,i,r),this.color=t,this.position=i,this.size=r,this.type=u.King}return __extends(i,n),i.prototype.GetValidMoves=function(n,i){typeof i=="undefined"&&(i=!0),console.log("Get moves King: "+i);var r=[];return this.MoveIsValid(1,1,n,i)&&(r[r.length]=new t(this.position.X+1,this.position.Y+1)),this.MoveIsValid(1,0,n,i)&&(r[r.length]=new t(this.position.X+1,this.position.Y)),this.MoveIsValid(1,-1,n,i)&&(r[r.length]=new t(this.position.X+1,this.position.Y-1)),this.MoveIsValid(0,1,n,i)&&(r[r.length]=new t(this.position.X,this.position.Y+1)),this.MoveIsValid(0,-1,n,i)&&(r[r.length]=new t(this.position.X,this.position.Y-1)),this.MoveIsValid(-1,1,n,i)&&(r[r.length]=new t(this.position.X-1,this.position.Y+1)),this.MoveIsValid(-1,0,n,i)&&(r[r.length]=new t(this.position.X-1,this.position.Y)),this.MoveIsValid(-1,-1,n,i)&&(r[r.length]=new t(this.position.X-1,this.position.Y-1)),r},i.prototype.Display=function(n){f(this,n),n.fillText("KING",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},i}(b),h=function(n){function i(t,i,r){n.call(this,t,i,r),this.color=t,this.position=i,this.size=r,this.type=u.Knight}return __extends(i,n),i.prototype.GetValidMoves=function(n,i){typeof i=="undefined"&&(i=!0),console.log("Get moves Knight: "+i);var r=[];return this.MoveIsValid(2,1,n,i)&&(r[r.length]=new t(this.position.X+2,this.position.Y+1)),this.MoveIsValid(2,-1,n,i)&&(r[r.length]=new t(this.position.X+2,this.position.Y-1)),this.MoveIsValid(-2,1,n,i)&&(r[r.length]=new t(this.position.X-2,this.position.Y+1)),this.MoveIsValid(-2,-1,n,i)&&(r[r.length]=new t(this.position.X-2,this.position.Y-1)),this.MoveIsValid(1,2,n,i)&&(r[r.length]=new t(this.position.X+1,this.position.Y+2)),this.MoveIsValid(1,-2,n,i)&&(r[r.length]=new t(this.position.X+1,this.position.Y-2)),this.MoveIsValid(-1,2,n,i)&&(r[r.length]=new t(this.position.X-1,this.position.Y+2)),this.MoveIsValid(-1,-2,n,i)&&(r[r.length]=new t(this.position.X-1,this.position.Y-2)),r},i.prototype.Display=function(n){f(this,n),n.fillText("KNIGHT",this.position.X*this.size+this.size/4,this.position.Y*this.size+this.size/4),n.stroke()},i}(b),k=function(){function n(){this.connections=[],this.board=new e(this.context),this.moves=0,this.currentTurn=i.WHITE}return n.prototype.addConnection=function(n){var t,i;this.connections[0]==null?(this.connections[0]=n,t=0):this.connections[1]==null&&(t=1,this.connections[1]=n,this.connections[0].sendUTF("color:white"),this.connections[1].sendUTF("color:black")),i=this;n.on("message",function(n){i.handleMessage(n,t)})},n.prototype.handleMessage=function(n,t){var i,f,e,r;if(n.type==="utf8"){i=n.utf8Data,i.indexOf;var u=i.indexOf(":"),o=i.substring(0,u).trim(),s=i.substring(u+1);console.log("Received Message: "+i);switch(o){case"move":r=JSON.parse(s.trim()),f=r[0],e=r[1],this.validateMove(f,e)?(this.connections[t].sendUTF("accepted"),this.connections[(t+1)%2].sendUTF("opponentmove:"+JSON.stringify(this.board.board))):this.connections[t].sendUTF("rejected:"+JSON.stringify(this.board.board))}}},n.prototype.sendGameState=function(){},n.prototype.sendMoveConfirmation=function(n){n.sendUTF("accepted")},n.prototype.validateMove=function(n,t){return this.board.selected=n,console.log("X: "+n.X+", Y: "+n.Y),console.log("X: "+t.X+", Y: "+t.Y),this.board.tryMove(t)},n}();n.ChessServerContext=k})(exports.Chess||(exports.Chess={})),Chess=exports.Chess