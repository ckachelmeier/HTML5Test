var chess=require("./Chess"),WebSocketServer=require("websocket").server,http=require("http"),ChessLobby=function(){function n(n){this.connections=[],this.maxConnections=0,this.numberConnected=0,this.server=http.createServer(function(n,t){console.log(new Date+" Received request for "+n.url),t.writeHead(404),t.end()}),this.server.listen(n,function(){console.log(new Date+" Server is listening on port "+n)}),this.wsServer=new WebSocketServer({httpServer:this.server,autoAcceptConnections:!1});var t=this;this.wsServer.on("request",function(n){t.newRequest(n)})}return n.prototype.closeRequest=function(n,t,i){var f=this.connections[i],u,r;if(console.log(new Date+" Peer "+f.connection.remoteAddress+" disconnected."),this.connections[i]=null,u=0,this.numberConnected--,i+1==this.maxConnections){for(r=0;r<this.maxConnections;r++)if(this.connections!=null&&u++,u==this.numberConnected)break;this.maxConnections=r}},n.prototype.newRequest=function(n){var i,t,r,u;if(!this.originIsAllowed(n.origin)){n.reject(),console.log(new Date+" Connection from origin "+n.origin+" rejected.");return}for(console.log(new Date+" Connection from origin "+n.origin+" not rejected."),i=n.accept(null,n.origin),t=0;this.connections[t];)t++;t>=this.maxConnections&&(this.maxConnections=t+1),this.numberConnected++,r=this,u={connection:i,name:""},this.connections[t]=u;i.on("message",function(n){r.handleMessage(n,t)});console.log(new Date+" Connection accepted. index: "+t);i.on("close",function(n,i){r.closeRequest(n,i,t)})},n.prototype.handleMessage=function(n,t){var i,s,e,o,r;if(n.type==="utf8"){i=n.utf8Data,i.indexOf;var u=i.indexOf(":"),h=u>0?i.substring(0,u).trim():i,f=u>0?i.substring(u+1).trim():"";console.log("Received Message: "+i),console.log("index: "+t);switch(h){case"name":this.newUserName(t,f);break;case"lobbyMessage":s={userName:this.connections[t].name,message:f},this.sendMessageToLoggedInUsers("lobbyMessage: "+JSON.stringify(s));break;case"startGame":if(this.connections[t].inGame){console.log("Failed starting game for "+this.connections[t].name),this.connections[t].connection.sendUTF("failed: Already in game");break}e=new chess.Chess.ChessServerContext,e.addConnection(this.connections[t].connection),this.connections[t].chessServer=e,console.log("Created Chess game for "+this.connections[t].name),this.connections[t].inGame=!0,this.connections[t].gameFull=!1,this.sendRefreshedGamesList();break;case"joinGame":if(o=f.indexOf("-"),o<0){this.connections[t].connection.sendUTF("failed: Message not in correct format");break}if(r=parseInt(f.substring(0,o)),this.connections[r].gameFull){this.connections[t].connection.sendUTF("failed: game is full");break}if(!this.connections[r].inGame){this.connections[t].connection.sendUTF("failed: game doesn't exist");break}this.connections[t].chessServer=this.connections[r].chessServer,this.connections[t].inGame=!0,this.connections[t].gameFull=!0,this.connections[r].gameFull=!0,this.connections[t].chessServer.addConnection(this.connections[t].connection)}}},n.prototype.newUserName=function(n,t){for(var r,i=0;i<this.maxConnections;i++)if(this.isLoggedIn(this.connections[i])&&this.connections[i].name.toLowerCase()==t.toLowerCase()){this.connections[i].connection.sendUTF("failed: User Name Taken");return}if(""+this.connections[n].name==""){for(this.sendMessageToLoggedInUsers("newUser: "+t),console.log(t+" joined"),this.connections[n].name=t,r={name:t,users:[],games:[]},i=0;i<this.maxConnections;i++)this.isLoggedIn(this.connections[i])&&(r.users[r.users.length]=this.connections[i].name,this.connections[i].inGame&&this.connections[i].gameFull&&(r.games[r.games.length]={id:i,name:this.connections[i].name}));this.connections[n].connection.sendUTF("loggedIn:"+JSON.stringify(r))}else this.connections[n].connection.sendUTF("failed: Can't Change Name")},n.prototype.sendRefreshedGamesList=function(){var t=[],n;for(console.log("max connections: "+this.maxConnections),n=0;n<this.maxConnections;n++)console.log("i: "+n+" : logged in: "+this.isLoggedIn(this.connections[n])+" : in game: "+this.connections[n].inGame+" : game full: "+this.connections[n].gameFull),this.isLoggedIn(this.connections[n])&&this.connections[n].inGame&&!this.connections[n].gameFull&&(t[t.length]={id:n,name:this.connections[n].name},console.log("here"));this.sendMessageToLoggedInUsers("gamesList: "+JSON.stringify(t))},n.prototype.sendMessageToLoggedInUsers=function(n,t){typeof t=="undefined"&&(t=-1),console.log("Sending message to users: "+n);for(var i=0;i<this.maxConnections;i++)t!=i&&this.isLoggedIn(this.connections[i])&&this.connections[i].connection.sendUTF(n)},n.prototype.isLoggedIn=function(n){return n==null?!1:n.connection?n.name?!0:!1:!1},n.prototype.originIsAllowed=function(){return!0},n}(),cl=new ChessLobby(8080)